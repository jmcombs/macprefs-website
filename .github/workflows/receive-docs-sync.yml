name: Receive Documentation Sync

on:
  repository_dispatch:
    types: [docs-updated]
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: jmcombs
          repositories: macprefs,macprefs-website

      - name: Fetch source documentation
        run: |
          git clone --depth 1 --filter=blob:none --sparse \
            https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/jmcombs/macprefs.git \
            macprefs-source
          cd macprefs-source
          git sparse-checkout set --no-cone docs README.md

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Transform documentation
        run: |
          # CLI docs: TypeScript + Handlebars transformation (Phase 2)
          # Rollback: Replace with `node scripts/legacy/transform-cli-docs.cjs` if issues discovered
          # Note: Legacy scripts in scripts/legacy/ require cli-enrichments.json to be in same directory
          npx tsx scripts/transform-cli-docs.ts macprefs-source/docs/CLI.json src/content/docs/reference/cli.mdx

          # Config docs: TypeScript + Handlebars transformation (Phase 3)
          # Rollback: Replace with `node scripts/legacy/transform-config-docs.cjs` if issues discovered
          if [ -f macprefs-source/docs/config-examples.md ]; then
            npx tsx scripts/transform-config-docs.ts macprefs-source/docs/config-examples.md src/content/docs/reference/configuration.mdx
          fi

          # Migration docs: TypeScript multi-page transformation (Phase 4)
          # This transforms the migration guide into 6 target MDX files:
          #   - getting-started/quick-start.mdx
          #   - guides/migration-curation.mdx
          #   - getting-started/first-config.mdx
          #   - guides/migration-pitfalls.mdx
          #   - guides/power-users.mdx (merge-section)
          #   - reference/troubleshooting.mdx
          # Rollback: Comment out this block to disable migration guide sync
          if [ -f macprefs-source/docs/MIGRATION_SETUP_CONFIG_AND_TROUBLESHOOTING.md ]; then
            npx tsx scripts/transform-migration-docs.ts macprefs-source/docs/MIGRATION_SETUP_CONFIG_AND_TROUBLESHOOTING.md
          fi

      - name: Cleanup source checkout
        run: rm -rf macprefs-source

      - uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'docs: sync documentation from macprefs'
          title: '[Auto] Update documentation from macprefs'
          body: |
            Automated sync from macprefs repository.
            Source commit: ${{ github.event.client_payload.sha }}
            Triggered by: ${{ github.event.client_payload.triggered_by }}
          branch: auto/docs-sync
          delete-branch: true
          labels: documentation,automated
          committer: macprefs-release-bot[bot] <macprefs-release-bot[bot]@users.noreply.github.com>
          author: macprefs-release-bot[bot] <macprefs-release-bot[bot]@users.noreply.github.com>
          # Only include documentation files to avoid requiring workflows permission
          add-paths: |
            src/content/docs/**
