name: Receive Documentation Sync

on:
  repository_dispatch:
    types: [docs-updated]
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: jmcombs
          repositories: macprefs,macprefs-website

      - name: Fetch source documentation
        run: |
          git clone --depth 1 --filter=blob:none --sparse \
            https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/jmcombs/macprefs.git \
            macprefs-source
          cd macprefs-source
          git sparse-checkout set --no-cone docs README.md

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Transform documentation
        run: |
          # Use JSON for CLI docs (more robust than markdown parsing)
          node scripts/transform-cli-docs.cjs macprefs-source/docs/CLI.json src/content/docs/reference/cli.mdx
          if [ -f macprefs-source/docs/config-examples.md ]; then
            node scripts/transform-config-docs.cjs macprefs-source/docs/config-examples.md src/content/docs/reference/configuration.mdx
          fi

      - name: Cleanup source checkout
        run: rm -rf macprefs-source

      - uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'docs: sync documentation from macprefs'
          title: '[Auto] Update documentation from macprefs'
          body: |
            Automated sync from macprefs repository.
            Source commit: ${{ github.event.client_payload.sha }}
            Triggered by: ${{ github.event.client_payload.triggered_by }}
          branch: auto/docs-sync
          delete-branch: true
          labels: documentation,automated
          committer: macprefs-release-bot[bot] <macprefs-release-bot[bot]@users.noreply.github.com>
          author: macprefs-release-bot[bot] <macprefs-release-bot[bot]@users.noreply.github.com>
          # Only include documentation files to avoid requiring workflows permission
          add-paths: |
            src/content/docs/**
